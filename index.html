<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyInterest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .next-payment-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            display: inline-block;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .nav-menu {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-button:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .section-title {
            font-size: 1.5em;
            color: #5e4b8c;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #5e4b8c;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .transactions {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.3s ease;
        }

        .transaction:hover {
            background: #f9f9f9;
        }

        .transaction-disposicion {
            color: #dc3545;
            font-weight: 500;
        }

        .transaction-amortizacion {
            color: #11998e;
            font-weight: 500;
        }

        .delete-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 5px 10px;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        }

        .interest-preview {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            padding: 25px;
            border-radius: 15px;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(142, 197, 252, 0.2);
        }

        .quarter-info {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .quarter-info h4 {
            color: #5e4b8c;
            margin-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí≥ MyInterest</h1>
            <p>Calcula y visualiza tus intereses trimestrales en tiempo real</p>
            <div class="next-payment-banner" id="headerPaymentDate">
                <!-- La fecha de pago se mostrar√° aqu√≠ -->
            </div>
        </div>

        <nav class="nav-menu">
            <button class="nav-button active" onclick="showSection('dashboard')">
                <span>üè†</span> Inicio
            </button>
            <button class="nav-button" onclick="showSection('operations')">
                <span>üí∞</span> Operaciones
            </button>
            <button class="nav-button" onclick="showSection('config')">
                <span>‚öôÔ∏è</span> Configuraci√≥n
            </button>
        </nav>

        <!-- Secci√≥n Dashboard -->
        <div id="dashboard" class="section active">
            <div class="card">
                <h2 class="section-title">üìä Resumen Actual</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="currentBalance">0 ‚Ç¨</div>
                        <div class="stat-label">Saldo Dispuesto</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="availableCredit">0 ‚Ç¨</div>
                        <div class="stat-label">Cr√©dito Disponible</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentQuarterInterest">0 ‚Ç¨</div>
                        <div class="stat-label">Intereses Trimestre Actual</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="daysUntilQuarterEnd">-</div>
                        <div class="stat-label">D√≠as hasta fin de trimestre</div>
                    </div>
                    <div class="stat-card" id="nextPaymentCard" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); cursor: help;" title="Los intereses se cobran el √∫ltimo d√≠a de cada trimestre">
                        <div class="stat-value" id="nextPaymentDate" style="font-size: 1.3em; color: white;">-</div>
                        <div class="stat-label" style="color: white; font-weight: bold;">üìÖ Pr√≥xima Fecha de Pago</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">üí∏ √öltimas Operaciones</h2>
                <div class="transactions" id="recentTransactions" style="max-height: 300px;">
                    <!-- Las √∫ltimas transacciones se mostrar√°n aqu√≠ -->
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="showSection('operations')" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);">Ver todas las operaciones ‚Üí</button>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 250, 0.95) 100%); border: 1px solid rgba(224, 195, 252, 0.3);">
                <h2 class="section-title">üìà Previsi√≥n de Intereses</h2>
                <div class="interest-preview" id="interestPreview">
                    <!-- La previsi√≥n de intereses se mostrar√° aqu√≠ -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <small style="color: #6c757d;" id="interestTip">
                        üí° Tip: Los intereses se calculan diariamente sobre el saldo dispuesto
                    </small>
                    <br>
                    <small style="color: #6c757d;">
                        üìå Guarda esta p√°gina en tus favoritos y rev√≠sala peri√≥dicamente antes del fin de cada trimestre
                    </small>
                </div>
                <div id="noConfigWarning" style="display: none; background: #fee14015; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 4px solid #f39c12;">
                    <strong>‚ö†Ô∏è Atenci√≥n:</strong> Para ver proyecciones precisas, configura primero tu l√≠mite de cr√©dito y tipo de inter√©s en <a href="javascript:void(0)" onclick="showSection('config')" style="color: #667eea; font-weight: bold;">Configuraci√≥n</a>
                </div>
            </div>
        </div>

        <!-- Secci√≥n Operaciones -->
        <div id="operations" class="section">
            <div class="card">
                <h2 class="section-title">üí∞ Nueva Operaci√≥n</h2>
                <div class="form-group">
                    <label for="operationType">Tipo de Operaci√≥n</label>
                    <select id="operationType">
                        <option value="disposicion">Disposici√≥n (Sacar dinero)</option>
                        <option value="amortizacion">Amortizaci√≥n (Devolver dinero)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="operationAmount">Importe (‚Ç¨)</label>
                    <input type="number" id="operationAmount" placeholder="Ej: 1000" step="0.01">
                </div>
                <div class="form-group">
                    <label for="operationDate">Fecha</label>
                    <input type="date" id="operationDate">
                </div>
                <button onclick="addOperation()">Registrar Operaci√≥n</button>
            </div>

            <div class="card">
                <h2 class="section-title">üìã Historial Completo de Operaciones</h2>
                <div class="transactions" id="transactionsList">
                    <!-- Las transacciones se mostrar√°n aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Secci√≥n Configuraci√≥n -->
        <div id="config" class="section">
            <div class="card">
                <h2 class="section-title">‚öôÔ∏è Configuraci√≥n de la L√≠nea de Cr√©dito</h2>
                <div class="form-group">
                    <label for="creditLimit">L√≠mite Total de Cr√©dito (‚Ç¨)</label>
                    <input type="number" id="creditLimit" placeholder="Ej: 50000" step="0.01">
                </div>
                <div class="form-group">
                    <label for="interestRate">Tipo de Inter√©s Anual (%)</label>
                    <input type="number" id="interestRate" placeholder="Ej: 5.5" step="0.01">
                </div>
                <div class="form-group">
                    <label for="startDate">Fecha de inicio para el c√°lculo</label>
                    <input type="date" id="startDate">
                </div>
                <button onclick="saveConfig()">Guardar Configuraci√≥n</button>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let appState = {
            creditLimit: 0,
            interestRate: 0,
            startDate: '',
            transactions: []
        };

        // Cargar datos del almacenamiento local
        function loadState() {
            const saved = localStorage.getItem('creditLineState');
            if (saved) {
                appState = JSON.parse(saved);
                if (!appState.startDate) appState.startDate = '';
                updateUI();

                // Si no hay configuraci√≥n inicial, mostrar aviso
                if (!appState.creditLimit || !appState.interestRate) {
                    setTimeout(() => {
                        const warningElement = document.getElementById('noConfigWarning');
                        if (warningElement && warningElement.style.display === 'block') {
                            warningElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 1000);
                }
            }
        }

        // Guardar estado
        function saveState() {
            localStorage.setItem('creditLineState', JSON.stringify(appState));
        }

        // Funci√≥n para cambiar entre secciones
        function showSection(sectionId) {
            // Ocultar todas las secciones
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Desactivar todos los botones del men√∫
            const buttons = document.querySelectorAll('.nav-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(sectionId).classList.add('active');
            
            // Activar el bot√≥n correspondiente
            const activeButton = Array.from(buttons).find(button => 
                button.onclick.toString().includes(sectionId)
            );
            if (activeButton) activeButton.classList.add('active');
            
            // Actualizar UI espec√≠fica de cada secci√≥n
            if (sectionId === 'dashboard') {
                updateRecentTransactions();
                updateInterestPreview();
                // Actualizar tip de intereses
                const tipElement = document.getElementById('interestTip');
                if (tipElement) {
                    if (appState.interestRate) {
                        tipElement.innerHTML = `üí° Tip: Los intereses se calculan diariamente sobre el saldo dispuesto al tipo del ${appState.interestRate}% anual`;
                    } else {
                        tipElement.innerHTML = `üí° Tip: Los intereses se calculan diariamente sobre el saldo dispuesto`;
                    }
                }
                // Mostrar/ocultar warning de configuraci√≥n
                const warningElement = document.getElementById('noConfigWarning');
                if (warningElement) {
                    if (!appState.creditLimit || !appState.interestRate) {
                        warningElement.style.display = 'block';
                    } else {
                        warningElement.style.display = 'none';
                    }
                }
            }
        }

        // Guardar configuraci√≥n inicial
        function saveConfig() {
            const creditLimit = parseFloat(document.getElementById('creditLimit').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const startDate = document.getElementById('startDate').value;

            if (!creditLimit || !interestRate) {
                alert('Por favor, completa todos los campos de configuraci√≥n');
                return;
            }

            appState.creditLimit = creditLimit;
            appState.interestRate = interestRate;
            appState.startDate = startDate;
            saveState();
            updateUI();
            
            // Mostrar confirmaci√≥n
            const savedMsg = document.createElement('div');
            savedMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #11998e; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; animation: slideIn 0.3s ease';
            savedMsg.textContent = '‚úÖ Configuraci√≥n guardada correctamente';
            document.body.appendChild(savedMsg);
            setTimeout(() => savedMsg.remove(), 3000);
            
            // Volver al dashboard para ver los cambios
            showSection('dashboard');
        }

        // Agregar operaci√≥n
        function addOperation() {
            const type = document.getElementById('operationType').value;
            const amount = parseFloat(document.getElementById('operationAmount').value);
            const date = document.getElementById('operationDate').value;

            if (!amount || !date) {
                alert('Por favor, completa todos los campos');
                return;
            }

            // Validar que no se exceda el l√≠mite
            const currentBalance = calculateCurrentBalance();
            if (type === 'disposicion' && currentBalance + amount > appState.creditLimit) {
                alert('Esta operaci√≥n exceder√≠a el l√≠mite de cr√©dito disponible');
                return;
            }

            if (type === 'amortizacion' && amount > currentBalance) {
                alert('No puedes devolver m√°s dinero del que tienes dispuesto');
                return;
            }

            const transaction = {
                id: Date.now(),
                type,
                amount,
                date,
                timestamp: new Date(date).getTime()
            };

            appState.transactions.push(transaction);
            appState.transactions.sort((a, b) => a.timestamp - b.timestamp);
            
            saveState();
            updateUI();

            // Limpiar formulario
            document.getElementById('operationAmount').value = '';
            document.getElementById('operationDate').value = '';
            
            // Mostrar confirmaci√≥n
            const savedMsg = document.createElement('div');
            savedMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #11998e; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; animation: slideIn 0.3s ease';
            savedMsg.textContent = `‚úÖ ${type === 'disposicion' ? 'Disposici√≥n' : 'Amortizaci√≥n'} de ${amount.toFixed(2)} ‚Ç¨ registrada`;
            document.body.appendChild(savedMsg);
            setTimeout(() => savedMsg.remove(), 3000);
            
            // Volver al dashboard para ver el impacto
            showSection('dashboard');
        }

        // Eliminar transacci√≥n
        window.deleteTransaction = function(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta operaci√≥n?')) {
                appState.transactions = appState.transactions.filter(t => t.id !== id);
                saveState();
                updateUI();
                // Si estamos en el dashboard, actualizar proyecciones
                if (document.getElementById('dashboard').classList.contains('active')) {
                    updateInterestPreview();
                }
            }
        }

        // Calcular saldo actual
        function calculateCurrentBalance() {
            let balance = 0;
            const today = new Date();
            
            appState.transactions.forEach(t => {
                const transactionDate = new Date(t.date);
                if (transactionDate <= today) {
                    if (t.type === 'disposicion') {
                        balance += t.amount;
                    } else {
                        balance -= t.amount;
                    }
                }
            });
            
            return Math.max(0, balance);
        }

        // Calcular intereses del trimestre actual
        function calculateQuarterInterest() {
            const currentQuarter = getCurrentQuarter();
            const quarterStart = getQuarterStart(currentQuarter);
            const quarterEnd = getQuarterEnd(currentQuarter);
            const today = new Date();
            const endDate = today < quarterEnd ? today : quarterEnd;
            
            let totalInterest = 0;
            let currentBalance = 0;
            
            // Obtener el saldo inicial al comienzo del trimestre
            appState.transactions.forEach(t => {
                const tDate = new Date(t.date);
                if (tDate < quarterStart) {
                    if (t.type === 'disposicion') {
                        currentBalance += t.amount;
                    } else {
                        currentBalance -= t.amount;
                    }
                }
            });
            
            // Calcular intereses d√≠a a d√≠a
            const dailyRate = appState.interestRate / 365 / 100;
            let currentDate = new Date(quarterStart);
            
            while (currentDate <= endDate) {
                // Aplicar transacciones del d√≠a
                appState.transactions.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate.toDateString() === currentDate.toDateString()) {
                        if (t.type === 'disposicion') {
                            currentBalance += t.amount;
                        } else {
                            currentBalance -= t.amount;
                        }
                    }
                });
                
                // Calcular inter√©s del d√≠a
                if (currentBalance > 0) {
                    totalInterest += currentBalance * dailyRate;
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return totalInterest;
        }

        // Sumar meses a una fecha
        function addMonths(date, months) {
            const d = new Date(date);
            d.setMonth(d.getMonth() + months);
            return d;
        }

        // Obtener informaci√≥n del trimestre que contiene la fecha indicada
        function getQuarterInfo(referenceDate) {
            if (!appState.startDate) {
                const quarter = Math.floor(referenceDate.getMonth() / 3) + 1;
                const startMonth = (quarter - 1) * 3;
                const start = new Date(referenceDate.getFullYear(), startMonth, 1);
                const end = new Date(referenceDate.getFullYear(), startMonth + 3, 0);
                return { year: referenceDate.getFullYear(), quarter, start, end };
            }

            const firstStart = new Date(appState.startDate);
            let start = new Date(firstStart);
            while (addMonths(start, 3) <= referenceDate) {
                start = addMonths(start, 3);
            }
            const end = addMonths(start, 3);
            end.setDate(end.getDate() - 1);
            const quarter = Math.floor(start.getMonth() / 3) + 1;
            const year = start.getFullYear();
            return { year, quarter, start, end };
        }

        // Obtener trimestre actual
        function getCurrentQuarter() {
            return getQuarterInfo(new Date());
        }

        // Obtener inicio del trimestre
        function getQuarterStart(quarter) {
            return quarter.start;
        }

        // Obtener fin del trimestre
        function getQuarterEnd(quarter) {
            return quarter.end;
        }

        // Calcular d√≠as hasta fin de trimestre
        function daysUntilQuarterEnd() {
            const today = new Date();
            const quarterEnd = getQuarterEnd(getCurrentQuarter());
            const diffTime = quarterEnd - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Actualizar UI
        function updateUI() {
            // Configuraci√≥n
            document.getElementById('creditLimit').value = appState.creditLimit || '';
            document.getElementById('interestRate').value = appState.interestRate || '';
            document.getElementById('startDate').value = appState.startDate || '';
            
            // Estad√≠sticas
            const currentBalance = calculateCurrentBalance();
            document.getElementById('currentBalance').textContent = currentBalance.toFixed(2) + ' ‚Ç¨';
            document.getElementById('availableCredit').textContent = (appState.creditLimit - currentBalance).toFixed(2) + ' ‚Ç¨';
            document.getElementById('currentQuarterInterest').textContent = calculateQuarterInterest().toFixed(2) + ' ‚Ç¨';
            document.getElementById('daysUntilQuarterEnd').textContent = daysUntilQuarterEnd();
            
            // Mostrar pr√≥xima fecha de pago
            const quarterEnd = getQuarterEnd(getCurrentQuarter());
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const nextPaymentCard = document.getElementById('nextPaymentCard');
            const headerBanner = document.getElementById('headerPaymentDate');

            if (!appState.creditLimit || !appState.interestRate) {
                document.getElementById('nextPaymentDate').textContent = '-';
                if (headerBanner) headerBanner.style.display = 'none';
                if (nextPaymentCard) nextPaymentCard.style.display = 'none';
            } else {
                document.getElementById('nextPaymentDate').textContent = quarterEnd.toLocaleDateString('es-ES', options);
                const daysLeft = daysUntilQuarterEnd();
                const urgencyIcon = daysLeft <= 5 ? 'üö®' : '‚è∞';

                if (headerBanner) {
                    headerBanner.style.display = 'inline-block';
                    if (daysLeft <= 5) {
                        headerBanner.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                        headerBanner.style.animation = 'pulse 1s ease-in-out infinite';
                    } else {
                        headerBanner.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                        headerBanner.style.animation = 'pulse 2s ease-in-out infinite';
                    }

                    headerBanner.innerHTML = `
                        ${urgencyIcon} PR√ìXIMO PAGO: ${quarterEnd.toLocaleDateString('es-ES', options).toUpperCase()}
                        <br>
                        <small style="font-size: 0.8em; font-weight: normal;">Faltan ${daysLeft} d√≠as - Intereses estimados: ${calculateProjectedInterest(getCurrentQuarter()).toFixed(2)} ‚Ç¨</small>
                        ${daysLeft <= 5 ? '<br><small style="font-size: 0.7em;">‚ö†Ô∏è Recuerda preparar los fondos necesarios</small>' : ''}
                    `;
                }

                if (nextPaymentCard) nextPaymentCard.style.display = 'block';
            }
            
            // Fecha por defecto en el formulario
            document.getElementById('operationDate').value = new Date().toISOString().split('T')[0];
            
            // Lista de transacciones
            updateTransactionsList();
            
            // Actualizar previsi√≥n
            updateInterestPreview();
            
            // Actualizar transacciones recientes si estamos en el dashboard
            if (document.getElementById('dashboard').classList.contains('active')) {
                updateRecentTransactions();
            }
            
            // Actualizar tip de intereses
            const tipElement = document.getElementById('interestTip');
            if (tipElement) {
                if (appState.interestRate) {
                    tipElement.innerHTML = `üí° Tip: Los intereses se calculan diariamente sobre el saldo dispuesto al tipo del ${appState.interestRate}% anual`;
                } else {
                    tipElement.innerHTML = `üí° Tip: Los intereses se calculan diariamente sobre el saldo dispuesto`;
                }
            }
            
            // Mostrar/ocultar warning de configuraci√≥n
            const warningElement = document.getElementById('noConfigWarning');
            if (warningElement) {
                if (!appState.creditLimit || !appState.interestRate) {
                    warningElement.style.display = 'block';
                } else {
                    warningElement.style.display = 'none';
                }
            }
        }

        // Actualizar transacciones recientes para el dashboard
        function updateRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            const recentTransactions = appState.transactions
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5); // Solo las √∫ltimas 5
            
            if (recentTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No hay operaciones registradas</p>';
                return;
            }
            
            container.innerHTML = recentTransactions
                .map(t => `
                    <div class="transaction">
                        <div>
                            <strong class="transaction-${t.type}">${t.type === 'disposicion' ? 'üì§ Disposici√≥n' : 'üì• Amortizaci√≥n'}</strong>
                            <br>
                            <small>${new Date(t.date).toLocaleDateString('es-ES')}</small>
                        </div>
                        <div>
                            <strong>${t.type === 'disposicion' ? '+' : '-'}${t.amount.toFixed(2)} ‚Ç¨</strong>
                        </div>
                    </div>
                `).join('');
        }

        // Actualizar lista de transacciones
        function updateTransactionsList() {
            const container = document.getElementById('transactionsList');
            
            if (appState.transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No hay operaciones registradas</p>';
                return;
            }
            
            container.innerHTML = appState.transactions
                .sort((a, b) => b.timestamp - a.timestamp)
                .map(t => `
                    <div class="transaction">
                        <div>
                            <strong class="transaction-${t.type}">${t.type === 'disposicion' ? 'üì§ Disposici√≥n' : 'üì• Amortizaci√≥n'}</strong>
                            <br>
                            <small>${new Date(t.date).toLocaleDateString('es-ES')}</small>
                        </div>
                        <div>
                            <strong>${t.type === 'disposicion' ? '+' : '-'}${t.amount.toFixed(2)} ‚Ç¨</strong>
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction(${t.id})">Eliminar</button>
                    </div>
                `).join('');
        }

        

        // Actualizar previsi√≥n de intereses
        function updateInterestPreview() {
            const container = document.getElementById('interestPreview');
            const currentQuarter = getCurrentQuarter();
            const nextQuarter = getNextQuarter(currentQuarter);
            
            // Si no hay configuraci√≥n, mostrar mensaje
            if (!appState.creditLimit || !appState.interestRate) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #6c757d;">
                        <p style="font-size: 1.2em; margin-bottom: 10px;">
                            üìä No hay proyecciones disponibles
                        </p>
                        <p>Configura tu l√≠nea de cr√©dito para ver las proyecciones de intereses</p>
                        <button onclick="showSection('config')" style="margin-top: 20px;">
                            Ir a Configuraci√≥n
                        </button>
                    </div>
                `;
                return;
            }
            
            // Calcular intereses para el trimestre actual y el siguiente
            const currentInterest = calculateQuarterInterest();
            const projectedCurrentInterest = calculateProjectedInterest(currentQuarter);
            const projectedNextInterest = calculateProjectedInterest(nextQuarter);
            
            container.innerHTML = `
                <p style="margin-bottom: 20px; color: #495057;">
                    <em>Proyecci√≥n basada en el saldo actual dispuesto de <strong style="${currentBalance / appState.creditLimit > 0.8 ? 'color: #dc3545;' : ''}">${calculateCurrentBalance().toFixed(2)} ‚Ç¨</strong>
                    ${currentBalance / appState.creditLimit > 0.8 ? '<span style="color: #dc3545; font-weight: bold;"> (‚ö†Ô∏è M√°s del 80% del l√≠mite)</span>' : ''}</em>
                </p>
                <div class="quarter-info" style="${daysUntilQuarterEnd() <= 5 ? 'border: 2px solid #dc3545; background: #fee14015;' : ''}">
                    <h4>Trimestre Actual (Q${currentQuarter.quarter} ${currentQuarter.year}) ${daysUntilQuarterEnd() <= 5 ? 'üö®' : ''}</h4>
                    <div class="info-row">
                        <span>Intereses acumulados hasta hoy:</span>
                        <strong>${currentInterest.toFixed(2)} ‚Ç¨</strong>
                    </div>
                    <div class="info-row">
                        <span>Proyecci√≥n fin de trimestre (manteniendo saldo actual):</span>
                        <strong>${projectedCurrentInterest.toFixed(2)} ‚Ç¨</strong>
                    </div>
                </div>
                <div class="quarter-info">
                    <h4>Pr√≥ximo Trimestre (Q${nextQuarter.quarter} ${nextQuarter.year})</h4>
                    <div class="info-row">
                        <span>Proyecci√≥n (manteniendo saldo actual):</span>
                        <strong>${projectedNextInterest.toFixed(2)} ‚Ç¨</strong>
                    </div>
                </div>
            `;
        }


        // Obtener siguiente trimestre
        function getNextQuarter(currentQuarter) {
            return getQuarterInfo(addMonths(currentQuarter.start, 3));
        }

        // Calcular intereses proyectados
        function calculateProjectedInterest(quarter) {
            const currentBalance = calculateCurrentBalance();
            const quarterStart = getQuarterStart(quarter);
            const quarterEnd = getQuarterEnd(quarter);
            const days = Math.ceil((quarterEnd - quarterStart) / (1000 * 60 * 60 * 24)) + 1;
            const dailyRate = appState.interestRate / 365 / 100;
            
            return currentBalance * dailyRate * days;
        }

        // Inicializar la aplicaci√≥n
        window.onload = function() {
            loadState();
            updateUI();
            
            // Hacer funciones globales para onclick
            window.saveConfig = saveConfig;
            window.addOperation = addOperation;
            window.showSection = showSection;
            
            // Si no hay configuraci√≥n inicial, mostrar aviso
            if (!appState.creditLimit || !appState.interestRate) {
                setTimeout(() => {
                    const warningElement = document.getElementById('noConfigWarning');
                    if (warningElement && warningElement.style.display === 'block') {
                        warningElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 1000);
            }
        };
    </script>
</body>
</html>
